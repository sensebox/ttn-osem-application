<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/routes/v1.1.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/routes/v1.1.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * Router for the `/v1.1` prefixed routes, meaning TTN HTTP integrations API v1
 * and this API v1.
 * @module routes/v1_1
 * @license MIT
 */

const router = require('express').Router(),
  { boxFromDevId, boxFromBoxId } = require('../database'),
  { TTNError, AuthorizationError, PayloadError } = require('../errors'),
  { getOrRegisterDevice } = require('../ttn'),
  cfg = require('../../config'),
  decoder = require('../decoding'),
  { createLogger } = require('../logging');

const log = createLogger('webhook-v1.1');

/**
 * Express middleware which finishes a request by sending an API response
 * contained in `res.locals.result`.
 * Also performs response logging while setting req.locals.responseTime.
 * Determines status code by checking the error type.
 *
 * @private
 * @param {Object|Error} req.locals.result - `{ code, message }`
 * @param {Date} req.time - The timestamp when we received the request.
 * @param {Box} req.box - The matched box
 */
const sendResponse = function sendResponse (req, res, next) {
  const r = res.locals.result;
  const { message } = r;
  let { code } = r;
  if (
    (r instanceof Error &amp;&amp; !(r instanceof TTNError)) || // filter non TTNError.code values
    !code
  ) {
    code = 501;
  }

  res.status(code).json({ code, message });
  res.locals.responseTime = Date.now() - req.time.getTime();

  if (r instanceof TTNError) {
    log.warn({
      res,
      box: req.box,
      payload: req.body,
      url: req.url
    }, message);
  } else if (r.code) {
    log.info({ res, url: req.url }, message);
  } else {
    log.error({
      err: r,
      res,
      box: req.box,
      payload: req.body,
      url: req.url,
    }, message);
  }

  if (typeof next === 'function') {
    return next();
  }
};

/**
 * Express middleware which matches a box against the payload, decodes the
 * message, and stores the measurements for the matched sensors.
 * Stores the matched box in `req.box`.
 * @private
 * @param {string} req.body - The payload in TTN HTTP Integration v1 format.
 */
const httpIntegrationHandler = function httpIntegrationHandler (req, res, next) {
  const { app_id, dev_id, payload_raw, payload_fields, port } = req.body;

  log.debug({ payload: req.body }, 'payload');

  if (
    !dev_id ||
    !app_id ||
    !(payload_raw || payload_fields)
  ) {
    res.locals.result = new PayloadError('any of [dev_id, app_id, payload_fields, payload_raw] is missing');

    return next();
  }

  // look up box for dev_id &amp; app_id in DB
  boxFromDevId(app_id, dev_id, port)
    .then(box => {
      log.debug({ box }, 'matched box');
      req.box = box;

      // decode measurements from request.body, req.box &amp; req.time
      return decoder.decodeRequest(req.body, box, req.time.toISOString());
    })

    // store measurements in DB
    .then(measurements => {
      log.debug({ measurements }, 'resulting measurements');

      return req.box.saveMeasurementsArray(measurements);
    })

    .then(() => {
      res.locals.result = { code: 201, message: 'measurements created' };

      return next();
    })

    .catch(err => {
      res.locals.result = err;

      return next();
    });
};

/**
 * Express middleware that checks the `Authorization` header against
 * `cfg.authTokens`. Expects a token as defined in `cfg.authTokens`, prefixed
 * with `"Bearer "`. Rejects a request with status 403 if not authorized.
 * @private
 * @param {string} req.header.authorization
 * @example
 * curl -H "authorization: Bearer secret" localhost:3000/v1.1/ttndevice/boxID
 */
const authOpensensemap = function authOpensensemap (req, res, next) {
  const token = req.header('authorization');
  if (token &amp;&amp; cfg.authTokens.includes(token.split(' ')[1])) {
    return next();
  }

  res.locals.result = new AuthorizationError();
  sendResponse(req, res);
};

/**
 * Express middleware that tries to match a TTN device to the box given in
 * `req.params.boxId`. If no device was found, a new one is registered.
 * @private
 * @param {string} req.params.boxId - The box to match a device `dev_id` against.
 */
const registerDeviceHandler = function registerDeviceHandler (req, res, next) {
  const { boxId } = req.params;

  // make sure the box actually exists
  return boxFromBoxId(boxId)
    .then(box => {
      req.box = box; // for the logger in sendResponse()
      const dev_eui = box.integrations.ttn ? box.integrations.ttn.dev_eui : '';

      return getOrRegisterDevice(boxId, dev_eui);
    })
    .then(device => {
      res.locals.result = { code: 200, message: device };
      next();
    })
    .catch(err => {
      res.locals.result = err;
      next();
    });
};

/**
 * Accepts a POST request from the TTN HTTP integrations uplink API, version 1
 * as specified {@link https://www.thethingsnetwork.org/docs/applications/http/|here},
 * and decodes its payload to store a set of measurements for a box.
 * The box is identified by `app_id`, `dev_id` and `port in `box.integrations.ttn`.
 * If a box specifies a port, it will only recieve measurements sent on that port.
 * @name 'POST /v1.1'
 * @example
 * curl -X POST -H "content-type: application/json" -d \
 *   '{ "app_id": "asdf", "dev_id": "qwerty", "payload_raw": "kzIrIYzlOycAMgEA" }' \
 *   localhost:3000/v1.1
 */
router.post('/', [
  httpIntegrationHandler,
  sendResponse,
]);

/**
 * Returns the TTN device options for a senseBox. If no TTN device for this box
 * exists, a new device is registered first.
 * Requires authentication via a bearer token in the `Authorization` header.
 *
 * box &lt;-> device matching:
 *
 * app_id = cfg.ttn.appId,
 * dev_id = box._id,
 * dev_eui = random,
 * app_skey/ nwskey = random
 *
 * @name 'GET /v1.1/ttndevice/:boxID'
 * @example
 * curl -H "authorization: Bearer secretkey" \
     http://localhost:3000/v1.1/ttndevice/59c585b44fe8d35c5787586e
 */
router.get('/ttndevice/:boxId', [
  authOpensensemap,
  registerDeviceHandler,
  sendResponse,
]);

module.exports = router;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-database.html">database</a></li><li><a href="module-decoding.html">decoding</a></li><li><a href="module-decoding_debug.html">decoding/debug</a></li><li><a href="module-decoding_helpers.html">decoding/helpers</a></li><li><a href="module-decoding_lora-serialization.html">decoding/lora-serialization</a></li><li><a href="module-decoding_sensebox_home.html">decoding/sensebox_home</a></li><li><a href="module-errors.html">errors</a></li><li><a href="module-logging.html">logging</a></li><li><a href="module-routes_v1_1.html">routes/v1_1</a></li><li><a href="module-ttn.html">ttn</a></li></ul><h3>Classes</h3><ul><li><a href="module-errors-AuthorizationError.html">AuthorizationError</a></li><li><a href="module-errors-BoxNotFoundError.html">BoxNotFoundError</a></li><li><a href="module-errors-DecodingError.html">DecodingError</a></li><li><a href="module-errors-LoraError.html">LoraError</a></li><li><a href="module-errors-PayloadError.html">PayloadError</a></li><li><a href="module-errors-TTNError.html">TTNError</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Dec 06 2017 15:19:29 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
